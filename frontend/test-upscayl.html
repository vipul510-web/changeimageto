<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Test Upscayl - Image Upscaling & Restoration</title>
    <meta name="description" content="Test Upscayl (Real-ESRGAN) for image upscaling and restoration">
    <link rel="canonical" href="https://www.changeimageto.com/test-upscayl.html" />

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
      :root{--bg:#0b0f13;--fg:#eaf0f6;--muted:#9aa7b2;--accent:#6aa7ff;--card:#12171d;--border:#1e2630}
      *{box-sizing:border-box}
      body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--fg);line-height:1.6}
      .container{max-width:1200px;margin:0 auto;padding:24px}
      .header h1{margin:0 0 8px}
      .header p{margin:0;color:var(--muted)}
      .logo-link{display:inline-flex;align-items:center;gap:10px;margin-bottom:10px;text-decoration:none;color:inherit}
      .logo-img{height:36px;width:auto;display:block}
      .uploader{position:relative;border:2px dashed var(--border);border-radius:12px;padding:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--card)}
      .uploader input{position:absolute;inset:0;opacity:0;cursor:pointer;display:block;width:100%;height:100%}
      .uploader-instructions{display:flex;flex-direction:column;align-items:center;color:var(--muted)}
      .uploader.drag{border-color:var(--accent);background:#101826}
      button, .btn{background:var(--accent);color:#001633;border:none;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer;text-decoration:none;display:inline-block}
      .btn.secondary{background:transparent;color:var(--fg);border:1px solid var(--border)}
      button[disabled]{opacity:.5;cursor:not-allowed}
      .preview{margin-top:24px}
      .preview-grid{display:grid;grid-template-columns:1fr;gap:16px}
      @media(min-width:900px){.preview-grid{grid-template-columns:1fr 1fr}}
      .preview img{width:100%;height:auto;border-radius:8px;display:block}
      .actions{margin-top:12px;display:flex;gap:12px;flex-wrap:wrap}
      .controls{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:20px}
      .controls label{display:block;margin-bottom:8px;font-weight:600;color:var(--fg)}
      .control-group{margin-bottom:16px}
      .control-row{display:flex;align-items:center;gap:12px;margin-top:8px}
      .control-row label{flex:0 0 140px;font-weight:400}
      .control-row select{width:200px;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--fg)}
      .control-row span{flex:0 0 60px;text-align:right;color:var(--muted);font-size:14px}
      .info-box{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:20px}
      .info-box p{margin:8px 0;color:var(--muted);font-size:14px}
    </style>
  </head>
  <body>
    <header class="container header">
      <a href="/" class="logo-link"><img src="./logo.png?v=20250921-1" alt="ChangeImageTo" class="logo-img" loading="eager" width="200" height="68" /></a>
      <h1>Test Upscayl (Real-ESRGAN)</h1>
      <p>Testing Upscayl's image upscaling and restoration capabilities</p>
    </header>

    <main class="container main">
      <div class="info-box">
        <p><strong>About Upscayl:</strong> Upscayl uses Real-ESRGAN NCNN-Vulkan for AI-powered image upscaling. According to their website, it can restore pixelated images and enhance low-resolution photos. This test will verify if it also removes noise/scratches or only upscales.</p>
        <p><strong>Note:</strong> Requires the Upscayl NCNN binary (realesrgan-ncnn-vulkan) to be installed locally. Processing may take 30-60 seconds on CPU.</p>
      </div>

      <form id="upload-form">
        <div class="controls">
          <div class="control-group">
            <label>Upscayl Controls</label>
            <div class="control-row">
              <label>Scale Factor:</label>
              <select id="scale">
                <option value="2">2x (Double Size)</option>
                <option value="3">3x (Triple Size)</option>
                <option value="4" selected>4x (Quadruple Size)</option>
              </select>
              <span></span>
            </div>
            <div class="control-row">
              <label>Model:</label>
              <select id="model">
                <option value="realesrgan-x4plus" selected>Real-ESRGAN x4+ (General - Best Quality)</option>
                <option value="realesrgan-x4plus-anime">Real-ESRGAN Anime (Anime/Cartoon)</option>
                <option value="realesr-animevideov3-x2">Real-ESR Anime Video v3 (2x)</option>
                <option value="realesr-animevideov3-x3">Real-ESR Anime Video v3 (3x)</option>
                <option value="realesr-animevideov3-x4">Real-ESR Anime Video v3 (4x)</option>
              </select>
              <span></span>
            </div>
          </div>
        </div>

        <div class="uploader" id="dropzone">
          <input type="file" id="file-input" accept="image/*" />
          <div class="uploader-instructions">
            <strong>Drop image here</strong>
            <span>or click to browse</span>
          </div>
        </div>

        <button id="process-btn" type="submit" disabled>Process with Upscayl</button>
      </form>

      <section class="preview" id="preview-section" hidden>
        <div class="preview-grid">
          <div>
            <h3>Original</h3>
            <img id="original-img" alt="Original preview" />
            <p style="color:var(--muted);font-size:12px;margin-top:8px" id="original-size"></p>
          </div>
          <div>
            <h3>Upscaled/Restored</h3>
            <p id="process-prompt" class="prompt">Press "Process with Upscayl" to test.</p>
            <div id="result-wrapper" hidden>
              <img id="result-img" alt="Upscaled result" />
              <p style="color:var(--muted);font-size:12px;margin-top:8px" id="result-size"></p>
              <div class="actions">
                <a id="download-link" download="upscaled.png" class="btn">Download PNG</a>
                <button id="reset-btn" class="btn secondary" type="button">Try Another Image</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('upload-form');
        const fileInput = document.getElementById('file-input');
        const dropzone = document.getElementById('dropzone');
        const processBtn = document.getElementById('process-btn');
        const originalImg = document.getElementById('original-img');
        const resultImg = document.getElementById('result-img');
        const previewSection = document.getElementById('preview-section');
        const resultWrapper = document.getElementById('result-wrapper');
        const processPrompt = document.getElementById('process-prompt');
        const downloadLink = document.getElementById('download-link');
        const resetBtn = document.getElementById('reset-btn');
        const originalSize = document.getElementById('original-size');
        const resultSize = document.getElementById('result-size');
        let currentFile = null;

        // File input handling
        fileInput.addEventListener('change', function(e) {
          if (e.target.files.length > 0) {
            currentFile = e.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
              originalImg.src = e.target.result;
              originalImg.onload = function() {
                originalSize.textContent = `${originalImg.naturalWidth} × ${originalImg.naturalHeight} pixels`;
              };
              previewSection.hidden = false;
              processPrompt.style.display = 'block';
              resultWrapper.hidden = true;
            };
            reader.readAsDataURL(currentFile);
            processBtn.disabled = false;
          }
        });

        // Drag and drop
        dropzone.addEventListener('dragover', function(e) {
          e.preventDefault();
          dropzone.classList.add('drag');
        });
        dropzone.addEventListener('dragleave', function() {
          dropzone.classList.remove('drag');
        });
        dropzone.addEventListener('drop', function(e) {
          e.preventDefault();
          dropzone.classList.remove('drag');
          if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            fileInput.dispatchEvent(new Event('change'));
          }
        });

        // Form submission
        form.addEventListener('submit', async function(e) {
          e.preventDefault();
          if (!currentFile) return;

          processBtn.disabled = true;
          processBtn.textContent = 'Processing… (This may take 30-60 seconds)';

          const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
          const currentPort = window.location.port || '8080';
          const backendPort = currentPort === '8080' ? '8000' : currentPort;
          const API_BASE = isLocal ? `http://127.0.0.1:${backendPort}` : 'https://bgremover-backend-121350814881.us-central1.run.app';

          const formData = new FormData();
          formData.append('file', currentFile);
          const scaleValue = document.getElementById('scale').value;
          formData.append('scale', scaleValue);
          
          // Handle model selection - some models have scale in their name
          let modelValue = document.getElementById('model').value;
          // If model has scale suffix (x2, x3, x4), use that scale
          if (modelValue.includes('-x2')) {
            modelValue = modelValue.replace('-x2', '');
            formData.append('scale', '2');
          } else if (modelValue.includes('-x3')) {
            modelValue = modelValue.replace('-x3', '');
            formData.append('scale', '3');
          } else if (modelValue.includes('-x4')) {
            modelValue = modelValue.replace('-x4', '');
            formData.append('scale', '4');
          }
          formData.append('model', modelValue);

          try {
            const response = await fetch(`${API_BASE}/api/test-upscayl`, {
              method: 'POST',
              body: formData,
            });

            if (!response.ok) {
              const errorText = await response.text();
              let errorMsg = errorText || 'Processing failed';
              try {
                const errorJson = JSON.parse(errorText);
                errorMsg = errorJson.detail || errorMsg;
              } catch (e) {
                // Not JSON, use as-is
              }
              throw new Error(errorMsg);
            }

            // Check content type first
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.startsWith('image/')) {
              const errorText = await response.text();
              throw new Error(`Server returned ${contentType} instead of image. Error: ${errorText.substring(0, 200)}`);
            }
            
            const blob = await response.blob();
            
            if (blob.size === 0) {
              throw new Error('Received empty response from server');
            }
            
            if (!blob.type.startsWith('image/')) {
              const text = await blob.text();
              throw new Error(`Response is not an image. Content: ${text.substring(0, 200)}`);
            }
            
            const imageUrl = URL.createObjectURL(blob);
            
            resultImg.onerror = function() {
              alert('Failed to load processed image. The image format may be invalid.');
              processBtn.disabled = false;
              processBtn.textContent = 'Process with Upscayl';
            };
            
            resultImg.src = imageUrl;
            resultImg.onload = function() {
              resultSize.textContent = `${resultImg.naturalWidth} × ${resultImg.naturalHeight} pixels`;
              processPrompt.style.display = 'none';
              resultWrapper.hidden = false;
              processBtn.disabled = false;
              processBtn.textContent = 'Process with Upscayl';
            };
            downloadLink.href = imageUrl;
            downloadLink.download = `upscayl-${Date.now()}.png`;
          } catch (error) {
            console.error('Upscayl error:', error);
            alert('Error processing image: ' + error.message + '\n\nCheck browser console for details.');
            processBtn.disabled = false;
            processBtn.textContent = 'Process with Upscayl';
          }
        });

        // Reset button
        resetBtn.addEventListener('click', function() {
          currentFile = null;
          fileInput.value = '';
          originalImg.src = '';
          resultImg.src = '';
          originalSize.textContent = '';
          resultSize.textContent = '';
          if (downloadLink.href && downloadLink.href.startsWith('blob:')) {
            URL.revokeObjectURL(downloadLink.href);
          }
          downloadLink.removeAttribute('href');
          previewSection.hidden = true;
          processBtn.disabled = true;
        });
      });
    </script>
  </body>
</html>
