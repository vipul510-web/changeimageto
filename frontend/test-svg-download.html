<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Download Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:hover {
            background: #0056b3;
        }
        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 12px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        img {
            max-width: 100%;
            border: 1px solid #ddd;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>SVG Download Test Page</h1>
    
    <div class="test-section">
        <h2>Test 1: Direct SVG Blob Download</h2>
        <p>This creates an SVG blob directly and downloads it.</p>
        <button onclick="testDirectSVGDownload()">Test Direct SVG Download</button>
        <div id="log1" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: SVG from API (Current Method)</h2>
        <p>This tests the actual API conversion method.</p>
        <input type="file" id="testFile" accept="image/*">
        <button onclick="testAPIConversion()">Test API Conversion</button>
        <div id="log2" class="log"></div>
        <div id="preview2"></div>
        <a id="downloadLink2" download style="display:none;">Download SVG</a>
    </div>

    <div class="test-section">
        <h2>Test 3: SVG Blob with Explicit Type</h2>
        <p>This creates an SVG blob with explicit MIME type.</p>
        <button onclick="testSVGWithExplicitType()">Test SVG with Explicit Type</button>
        <div id="log3" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Test 4: Download via Blob URL vs Data URL</h2>
        <p>Compare blob URL vs data URL download methods.</p>
        <button onclick="testBlobVsDataURL()">Test Both Methods</button>
        <div id="log4" class="log"></div>
    </div>

    <script>
        function log(section, message) {
            const logEl = document.getElementById(`log${section}`);
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${message}<br>`;
            logEl.scrollTop = logEl.scrollHeight;
            console.log(`[Test ${section}]`, message);
        }

        // Test 1: Direct SVG creation and download
        function testDirectSVGDownload() {
            log(1, 'Creating direct SVG blob...');
            const svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200">
  <rect width="200" height="200" fill="red"/>
  <text x="100" y="100" text-anchor="middle" fill="white" font-size="20">TEST SVG</text>
</svg>`;
            
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            log(1, `Blob created: size=${blob.size}, type=${blob.type}`);
            
            blob.text().then(text => {
                log(1, `Blob content (first 100 chars): ${text.substring(0, 100)}`);
                log(1, `Is valid SVG? ${text.trim().startsWith('<?xml') || text.trim().startsWith('<svg')}`);
            });

            const url = URL.createObjectURL(blob);
            log(1, `Blob URL created: ${url}`);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'test-direct.svg';
            a.click();
            log(1, 'Download triggered');
            
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        // Test 2: API conversion (current method)
        let testFile = null;
        document.getElementById('testFile').addEventListener('change', (e) => {
            testFile = e.target.files[0];
            log(2, `File selected: ${testFile.name}, size=${testFile.size}, type=${testFile.type}`);
        });

        async function testAPIConversion() {
            if (!testFile) {
                log(2, 'ERROR: No file selected');
                return;
            }

            log(2, 'Starting API conversion test...');
            const body = new FormData();
            body.append('file', testFile);
            body.append('target_format', 'svg');
            body.append('transparent', 'true');

            const apiBase = 'https://bgremover-backend-121350814881.us-central1.run.app';
            
            try {
                log(2, 'Sending request to API...');
                const res = await fetch(apiBase + '/api/convert-format', { method: 'POST', body });
                log(2, `Response status: ${res.status}, OK: ${res.ok}`);
                
                if (!res.ok) {
                    const errorText = await res.text();
                    log(2, `ERROR: ${errorText}`);
                    return;
                }

                const ct = res.headers.get('content-type') || '';
                log(2, `Content-Type: ${ct}`);
                
                const blob = await res.blob();
                log(2, `Blob received: size=${blob.size}, type=${blob.type}`);
                
                // Verify blob content
                const text = await blob.text();
                log(2, `Blob content (first 200 chars): ${text.substring(0, 200)}`);
                log(2, `Is valid SVG? ${text.trim().startsWith('<?xml') || text.trim().startsWith('<svg')}`);
                
                // Create blob URL
                const url = URL.createObjectURL(blob);
                log(2, `Blob URL: ${url}`);
                
                // Set up download link
                const downloadLink = document.getElementById('downloadLink2');
                downloadLink.href = url;
                downloadLink.download = `test-api-${Date.now()}.svg`;
                downloadLink.style.display = 'inline-block';
                downloadLink.textContent = 'Download SVG (Right-click to inspect)';
                
                // Preview
                const preview = document.getElementById('preview2');
                preview.innerHTML = `<img src="${url}" alt="SVG Preview" style="max-width: 300px;">`;
                
                // Also test programmatic download
                log(2, 'Testing programmatic download...');
                const a = document.createElement('a');
                a.href = url;
                a.download = `test-api-programmatic-${Date.now()}.svg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                log(2, 'Programmatic download triggered');
                
            } catch (err) {
                log(2, `ERROR: ${err.message}`);
                console.error(err);
            }
        }

        // Test 3: SVG with explicit type
        function testSVGWithExplicitType() {
            log(3, 'Creating SVG blob with explicit type...');
            const svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200">
  <circle cx="100" cy="100" r="80" fill="blue"/>
  <text x="100" y="110" text-anchor="middle" fill="white" font-size="16">EXPLICIT TYPE</text>
</svg>`;
            
            // Try different blob types
            const types = [
                'image/svg+xml',
                'image/svg+xml;charset=utf-8',
                'text/xml',
                'application/xml'
            ];
            
            types.forEach((type, i) => {
                const blob = new Blob([svgContent], { type });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `test-explicit-${i}-${type.replace(/[\/;]/g, '-')}.svg`;
                log(3, `Created blob with type "${type}", size=${blob.size}`);
                a.click();
                setTimeout(() => URL.revokeObjectURL(url), 100);
            });
        }

        // Test 4: Blob URL vs Data URL
        function testBlobVsDataURL() {
            log(4, 'Testing Blob URL vs Data URL download...');
            const svgContent = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200">
  <rect width="200" height="200" fill="green"/>
  <text x="100" y="100" text-anchor="middle" fill="white" font-size="18">BLOB vs DATA</text>
</svg>`;
            
            // Method 1: Blob URL
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const blobUrl = URL.createObjectURL(blob);
            const a1 = document.createElement('a');
            a1.href = blobUrl;
            a1.download = 'test-blob-url.svg';
            log(4, 'Method 1: Blob URL download');
            a1.click();
            
            // Method 2: Data URL
            const dataUrl = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svgContent);
            const a2 = document.createElement('a');
            a2.href = dataUrl;
            a2.download = 'test-data-url.svg';
            log(4, 'Method 2: Data URL download');
            a2.click();
            
            setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
        }
    </script>
</body>
</html>

